diff -urN module-init-tools-3.0.org/insmod.c module-init-tools-3.0/insmod.c
--- module-init-tools-3.0.org/insmod.c	2004-07-17 19:56:16.102393536 +0200
+++ module-init-tools-3.0/insmod.c	2004-07-17 19:57:26.913628592 +0200
@@ -28,6 +28,7 @@
 #include <errno.h>
 #include <asm/unistd.h>
 
+#include "zlibsupport.h"
 #include "backwards_compat.c"
 
 #define streq(a,b) (strcmp((a),(b)) == 0)
@@ -57,34 +58,6 @@
 	}
 }
 
-static void *grab_file(const char *filename, unsigned long *size)
-{
-	unsigned int max = 16384;
-	int ret, fd;
-	void *buffer = malloc(max);
-
-	if (streq(filename, "-"))
-		fd = dup(STDIN_FILENO);
-	else
-		fd = open(filename, O_RDONLY, 0);
-
-	if (fd < 0)
-		return NULL;
-
-	*size = 0;
-	while ((ret = read(fd, buffer + *size, max - *size)) > 0) {
-		*size += ret;
-		if (*size == max)
-			buffer = realloc(buffer, max *= 2);
-	}
-	if (ret < 0) {
-		free(buffer);
-		buffer = NULL;
-	}
-	close(fd);
-	return buffer;
-}
-
 int main(int argc, char *argv[])
 {
 	unsigned int i;
diff -urN module-init-tools-3.0.org/Makefile.am module-init-tools-3.0/Makefile.am
--- module-init-tools-3.0.org/Makefile.am	2004-07-17 19:56:16.090395360 +0200
+++ module-init-tools-3.0/Makefile.am	2004-07-17 20:05:45.953762960 +0200
@@ -1,14 +1,12 @@
-insmod_SOURCES = insmod.c testing.h
+insmod_SOURCES = insmod.c zlibsupport.c testing.h zlibsupport.h
 lsmod_SOURCES = lsmod.c testing.h
 modprobe_SOURCES = modprobe.c zlibsupport.c testing.h zlibsupport.h
 rmmod_SOURCES = rmmod.c testing.h
 depmod_SOURCES = depmod.c moduleops.c tables.c zlibsupport.c depmod.h moduleops.h tables.h list.h testing.h  zlibsupport.h
 modinfo_SOURCES = modinfo.c zlibsupport.c testing.h zlibsupport.h
 
-insmod_static_SOURCES = insmod.c
+insmod_static_SOURCES = insmod.c zlibsupport.c zlibsupport.h
 insmod_static_LDFLAGS = -static
-# We don't want the $(zlib_flags) here: that makes a dynamic executable
-insmod_static_LDADD = 
 
 EXTRA_insmod_SOURCES = backwards_compat.c
 EXTRA_lsmod_SOURCES = backwards_compat.c
